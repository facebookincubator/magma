---
################################################################################
# Copyright 2020 The Magma Authors.

# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

- name: Ensure rngd installed (saves lots of time waiting for random numbers)
  apt: pkg=rng-tools state=present update_cache=yes
  when: use_rngd

- name: Start rngd
  command: rngd -r /dev/urandom
  become: yes
  when: use_rngd

- name: Create openssl keys
  command: >
    openssl req -newkey rsa:2048 -nodes -x509 -days 3650
    -keyout {{ keypath | quote }}
    -out {{ crtpath | quote }}
    -subj "/C=US/ST=Calfiornia/L=Menlo Park/O=Test Organization/OU=TEST/CN=testssl.localdomain"
  become: yes
  args:
    creates: "{{ keypath }}"

- name: Stop rngd
  ignore_errors: yes
  command: killall rngd
  become: yes
  when: use_rngd
