---
# Copyright 2020 The Magma Authors.

# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

###############################################
# Download and build gHZ (load test dependency)
###############################################
- name: Clone ghz repo
  become: yes
  git:
    repo: 'https://github.com/bojand/ghz'
    dest: "{{ ghz_root }}"
    version: v0.94.0
    force: yes
  when: full_provision

- name: Upload script to build ghz
  become: yes
  copy:
    src: build_ghz.sh
    dest: /var/tmp/build_ghz.sh
    mode: 0755
  when: full_provision

- name: Build ghz
  become: yes
  command: "/var/tmp/build_ghz.sh"
  environment:
    GHZ_ROOT: "{{ ghz_root }}"
    GO_BIN: "{{ go_bin }}"
  when: full_provision

- name: Copy ghz to bin
  copy:
    src: "{{ ghz_root }}/cmd/ghz/ghz"
    dest: /usr/local/bin/ghz
    force: yes
    remote_src: yes
    mode: 0755
  when: full_provision
